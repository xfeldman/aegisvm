name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14  # M-series ARM64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for git describe version

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install dependencies
        run: brew tap slp/krun && brew install libkrun e2fsprogs

      - name: Set version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Build all binaries
        run: make all VERSION=${{ env.VERSION }}

      - name: Run tests
        run: make test

      - name: Package core release tarball
        run: |
          TARBALL="aegisvm-${VERSION}-darwin-arm64.tar.gz"
          make release-tarball VERSION=${VERSION}
          mv "aegisvm-${VERSION}-darwin-arm64.tar.gz" "${TARBALL}"
          echo "TARBALL=${TARBALL}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          shasum -a 256 "${TARBALL}" | awk '{print $1}' > "${TARBALL}.sha256"

      - name: Package agent kit release tarball
        run: |
          KIT_TARBALL="aegisvm-agent-kit-${VERSION}-darwin-arm64.tar.gz"
          make release-kit-tarball VERSION=${VERSION}
          echo "KIT_TARBALL=${KIT_TARBALL}" >> $GITHUB_ENV
          shasum -a 256 "${KIT_TARBALL}" | awk '{print $1}' > "${KIT_TARBALL}.sha256"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${VERSION}" \
            --title "AegisVM ${VERSION}" \
            --generate-notes \
            "${TARBALL}" \
            "${TARBALL}.sha256" \
            "${KIT_TARBALL}" \
            "${KIT_TARBALL}.sha256"

      - name: Update Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN }}
        if: env.TAP_TOKEN != ''
        run: |
          SHA256=$(cat "${TARBALL}.sha256")
          KIT_SHA256=$(cat "${KIT_TARBALL}.sha256")
          DOWNLOAD_URL="https://github.com/xfeldman/aegisvm/releases/download/${VERSION}/${TARBALL}"
          KIT_DOWNLOAD_URL="https://github.com/xfeldman/aegisvm/releases/download/${VERSION}/${KIT_TARBALL}"

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/xfeldman/homebrew-aegisvm.git" /tmp/homebrew-aegisvm
          cd /tmp/homebrew-aegisvm

          # Update core formula
          sed -i '' "s|url \".*\"|url \"${DOWNLOAD_URL}\"|" Formula/aegisvm.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/aegisvm.rb
          sed -i '' "s|version \".*\"|version \"${VERSION#v}\"|" Formula/aegisvm.rb

          # Update agent kit formula
          sed -i '' "s|url \".*\"|url \"${KIT_DOWNLOAD_URL}\"|" Formula/aegisvm-agent-kit.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${KIT_SHA256}\"|" Formula/aegisvm-agent-kit.rb
          sed -i '' "s|version \".*\"|version \"${VERSION#v}\"|" Formula/aegisvm-agent-kit.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/aegisvm.rb Formula/aegisvm-agent-kit.rb
          git commit -m "${VERSION}"
          git push
