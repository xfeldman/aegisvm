name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release-macos:
    runs-on: macos-14  # M-series ARM64
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed for git describe version

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: brew tap slp/krun && brew install libkrun e2fsprogs

      - name: Set version from tag
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Build frontend
        run: make ui-frontend

      - name: Build all binaries
        run: make all VERSION=${{ env.VERSION }}

      - name: Run tests
        run: make test

      - name: Package core release tarball
        run: |
          TARBALL="aegisvm-${VERSION}-darwin-arm64.tar.gz"
          make release-tarball VERSION=${VERSION}
          mv "aegisvm-${VERSION}-darwin-arm64.tar.gz" "${TARBALL}"
          echo "TARBALL=${TARBALL}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          shasum -a 256 "${TARBALL}" | awk '{print $1}' > "${TARBALL}.sha256"

      - name: Package agent kit release tarball
        run: |
          KIT_TARBALL="aegisvm-agent-kit-${VERSION}-darwin-arm64.tar.gz"
          make release-kit-tarball VERSION=${VERSION}
          echo "KIT_TARBALL=${KIT_TARBALL}" >> $GITHUB_ENV
          shasum -a 256 "${KIT_TARBALL}" | awk '{print $1}' > "${KIT_TARBALL}.sha256"

      # --- Desktop App (DMG) ---
      - name: Build desktop app
        run: make package-mac VERSION=${VERSION}

      - name: Import signing certificate
        if: env.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PWD: ${{ secrets.KEYCHAIN_PWD }}
        run: |
          CERT_FILE=$(mktemp /tmp/cert.XXXXXX.p12)
          echo "${MACOS_CERTIFICATE}" | base64 --decode > "${CERT_FILE}"
          security create-keychain -p "${KEYCHAIN_PWD}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${KEYCHAIN_PWD}" build.keychain
          security import "${CERT_FILE}" -k build.keychain -P "${MACOS_CERTIFICATE_PWD}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${KEYCHAIN_PWD}" build.keychain
          rm -f "${CERT_FILE}"

      - name: Sign .app bundle
        if: env.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          APP="bin/AegisVM.app"

          # Sign bundled dylibs in Frameworks (bottom-up: dylibs before binaries)
          for lib in ${APP}/Contents/Frameworks/*.dylib; do
            [ -f "$lib" ] || continue
            codesign --sign "${MACOS_SIGNING_IDENTITY}" \
              --options runtime --timestamp --force "$lib"
          done

          # Sign all Mach-O binaries in Resources
          # Linux binaries (aegis-harness, aegis-agent, aegis-mcp-guest) are skipped
          for bin in ${APP}/Contents/Resources/*; do
            [ -f "$bin" ] || continue
            # Skip non-Mach-O files (Linux ELF binaries, JSON, etc.)
            if ! file "$bin" | grep -q "Mach-O"; then
              echo "Skipping non-Mach-O: $bin"
              continue
            fi
            if [ "$(basename "$bin")" = "aegis-vmm-worker" ]; then
              codesign --sign "${MACOS_SIGNING_IDENTITY}" --entitlements entitlements.plist \
                --options runtime --timestamp --force "$bin"
            else
              codesign --sign "${MACOS_SIGNING_IDENTITY}" \
                --options runtime --timestamp --force "$bin"
            fi
          done

          # Sign main executable
          codesign --sign "${MACOS_SIGNING_IDENTITY}" \
            --options runtime --timestamp --force "${APP}/Contents/MacOS/aegis-ui"

          # Sign the bundle
          codesign --sign "${MACOS_SIGNING_IDENTITY}" \
            --options runtime --timestamp --force "${APP}"

      - name: Create DMG
        if: env.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          brew install create-dmg
          DMG_NAME="AegisVM-${VERSION}.dmg"

          # create-dmg expects a folder containing the .app
          mkdir -p /tmp/dmg-staging
          cp -R bin/AegisVM.app /tmp/dmg-staging/

          create-dmg \
            --volname "AegisVM" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "AegisVM.app" 150 190 \
            --app-drop-link 450 190 \
            "${DMG_NAME}" \
            "/tmp/dmg-staging"

          rm -rf /tmp/dmg-staging

          # Sign the DMG
          codesign --sign "${MACOS_SIGNING_IDENTITY}" --timestamp --force "${DMG_NAME}"

          echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV

      - name: Notarize DMG
        if: env.MACOS_CERTIFICATE != ''
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          NOTARIZATION_PWD: ${{ secrets.NOTARIZATION_PWD }}
        run: |
          SUBMIT_OUT=$(xcrun notarytool submit "${DMG_NAME}" \
            --apple-id "${APPLE_ID}" \
            --team-id "${APPLE_TEAM_ID}" \
            --password "${NOTARIZATION_PWD}" \
            --wait 2>&1) || true
          echo "${SUBMIT_OUT}"

          SUBMISSION_ID=$(echo "${SUBMIT_OUT}" | grep "id:" | head -1 | awk '{print $2}')

          if echo "${SUBMIT_OUT}" | grep -q "status: Invalid"; then
            echo "::error::Notarization failed. Fetching log..."
            xcrun notarytool log "${SUBMISSION_ID}" \
              --apple-id "${APPLE_ID}" \
              --team-id "${APPLE_TEAM_ID}" \
              --password "${NOTARIZATION_PWD}" \
              notarization-log.json
            cat notarization-log.json
            exit 1
          fi

          xcrun stapler staple "${DMG_NAME}"

      - name: Checksum DMG
        if: env.DMG_NAME != ''
        run: |
          shasum -a 256 "${DMG_NAME}" | awk '{print $1}' > "${DMG_NAME}.sha256"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ASSETS=("${TARBALL}" "${TARBALL}.sha256" "${KIT_TARBALL}" "${KIT_TARBALL}.sha256")
          if [ -n "${DMG_NAME}" ] && [ -f "${DMG_NAME}" ]; then
            ASSETS+=("${DMG_NAME}" "${DMG_NAME}.sha256")
          fi

          gh release create "${VERSION}" \
            --title "AegisVM ${VERSION}" \
            --generate-notes \
            "${ASSETS[@]}"

      - name: Cleanup signing keychain
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true
          security default-keychain -s login.keychain 2>/dev/null || true

      - name: Update Homebrew tap
        env:
          TAP_TOKEN: ${{ secrets.TAP_TOKEN }}
        if: env.TAP_TOKEN != ''
        run: |
          SHA256=$(cat "${TARBALL}.sha256")
          KIT_SHA256=$(cat "${KIT_TARBALL}.sha256")
          DOWNLOAD_URL="https://github.com/xfeldman/aegisvm/releases/download/${VERSION}/${TARBALL}"
          KIT_DOWNLOAD_URL="https://github.com/xfeldman/aegisvm/releases/download/${VERSION}/${KIT_TARBALL}"

          git clone "https://x-access-token:${TAP_TOKEN}@github.com/xfeldman/homebrew-aegisvm.git" /tmp/homebrew-aegisvm
          cd /tmp/homebrew-aegisvm

          # Update core formula
          sed -i '' "s|url \".*\"|url \"${DOWNLOAD_URL}\"|" Formula/aegisvm.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/aegisvm.rb
          sed -i '' "s|version \".*\"|version \"${VERSION#v}\"|" Formula/aegisvm.rb

          # Update agent kit formula
          sed -i '' "s|url \".*\"|url \"${KIT_DOWNLOAD_URL}\"|" Formula/aegisvm-agent-kit.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${KIT_SHA256}\"|" Formula/aegisvm-agent-kit.rb
          sed -i '' "s|version \".*\"|version \"${VERSION#v}\"|" Formula/aegisvm-agent-kit.rb

          # Update desktop cask (only if DMG was built)
          if [ -n "${DMG_NAME}" ] && [ -f "${DMG_NAME}.sha256" ]; then
            DMG_SHA256=$(cat "${DMG_NAME}.sha256")
            DMG_URL="https://github.com/xfeldman/aegisvm/releases/download/${VERSION}/${DMG_NAME}"
            mkdir -p Casks
            if [ -f Casks/aegisvm-desktop.rb ]; then
              sed -i '' "s|url \".*\"|url \"${DMG_URL}\"|" Casks/aegisvm-desktop.rb
              sed -i '' "s|sha256 \".*\"|sha256 \"${DMG_SHA256}\"|" Casks/aegisvm-desktop.rb
              sed -i '' "s|version \".*\"|version \"${VERSION#v}\"|" Casks/aegisvm-desktop.rb
            fi
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "${VERSION}"
          git push

  release-linux:
    needs: release-macos  # release must exist before we upload to it
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Set version from tag
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "DEB_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV

      - name: Build all binaries
        run: make all VERSION=${VERSION}

      - name: Run tests
        run: make test

      - name: Download Cloud Hypervisor
        run: make cloud-hypervisor

      - name: Download microVM kernel
        run: make kernel

      - name: Build .deb packages
        run: |
          make deb VERSION=${VERSION}
          make deb-agent-kit VERSION=${VERSION}

      - name: Build Linux tarball
        run: make release-linux-tarball VERSION=${VERSION}

      - name: Create unversioned .deb copies (latest)
        run: |
          cp debian/aegisvm_${DEB_VERSION}_${ARCH}.deb aegisvm-${ARCH}.deb
          cp debian/aegisvm-agent-kit_${DEB_VERSION}_${ARCH}.deb aegisvm-agent-kit-${ARCH}.deb

      # --- Desktop App (AppImage) ---
      - name: Install desktop app build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libfuse2

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build frontend
        run: make ui-frontend

      - name: Install appimagetool
        run: |
          MACHINE=$(uname -m)
          curl -sSL -o /tmp/appimagetool \
            "https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-${MACHINE}.AppImage"
          chmod +x /tmp/appimagetool
          # CI runners lack FUSE â€” extract and use directly
          cd /tmp && ./appimagetool --appimage-extract > /dev/null 2>&1
          sudo mv /tmp/squashfs-root /opt/appimagetool
          sudo ln -sf /opt/appimagetool/AppRun /usr/local/bin/appimagetool

      - name: Build AppImage
        run: make package-linux-appimage VERSION=${VERSION}

      - name: Generate checksums
        run: |
          sha256sum debian/aegisvm_${DEB_VERSION}_${ARCH}.deb | awk '{print $1}' > debian/aegisvm_${DEB_VERSION}_${ARCH}.deb.sha256
          sha256sum debian/aegisvm-agent-kit_${DEB_VERSION}_${ARCH}.deb | awk '{print $1}' > debian/aegisvm-agent-kit_${DEB_VERSION}_${ARCH}.deb.sha256
          sha256sum aegisvm-${ARCH}.deb | awk '{print $1}' > aegisvm-${ARCH}.deb.sha256
          sha256sum aegisvm-agent-kit-${ARCH}.deb | awk '{print $1}' > aegisvm-agent-kit-${ARCH}.deb.sha256
          sha256sum aegisvm-${VERSION}-linux-${ARCH}.tar.gz | awk '{print $1}' > aegisvm-${VERSION}-linux-${ARCH}.tar.gz.sha256
          sha256sum AegisVM-${VERSION}-${ARCH}.AppImage | awk '{print $1}' > AegisVM-${VERSION}-${ARCH}.AppImage.sha256

      - name: Upload Linux artifacts to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${VERSION}" \
            debian/aegisvm_${DEB_VERSION}_${ARCH}.deb \
            debian/aegisvm_${DEB_VERSION}_${ARCH}.deb.sha256 \
            debian/aegisvm-agent-kit_${DEB_VERSION}_${ARCH}.deb \
            debian/aegisvm-agent-kit_${DEB_VERSION}_${ARCH}.deb.sha256 \
            aegisvm-${ARCH}.deb \
            aegisvm-${ARCH}.deb.sha256 \
            aegisvm-agent-kit-${ARCH}.deb \
            aegisvm-agent-kit-${ARCH}.deb.sha256 \
            aegisvm-${VERSION}-linux-${ARCH}.tar.gz \
            aegisvm-${VERSION}-linux-${ARCH}.tar.gz.sha256 \
            AegisVM-${VERSION}-${ARCH}.AppImage \
            AegisVM-${VERSION}-${ARCH}.AppImage.sha256
